name: Publish Release
run-name: "Release ${{ github.ref_name }} (Build #${{ github.run_number }})"

permissions:
   contents: write

on:
   push:
      tags:
         - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Typst
        uses: typst-community/setup-typst@v4
        with:
          typst-version: latest

      # SCHRITT 1: Prüft, ob CHANGELOG.md seit dem letzten Tag geändert wurde
      - name: Check Changelog Status
        id: check_changelog
        run: |
          set -e
          CURRENT_TAG=${{ github.ref_name }}
          
          # Finde den Tag VOR dem aktuellen Tag.
          # Das '--exclude' verhindert, dass der aktuelle Tag selbst gefunden wird.
          # '--first-parent' hält die History sauber.
          PREV_TAG=$(git rev-list --tags --max-count=1 --skip=1 --no-walk $CURRENT_TAG)
          
          if [ -z "$PREV_TAG" ]; then
            echo "::notice::Kein vorheriger Tag gefunden. Release wird als erster Tag fortgesetzt."
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PREV_TAG_NAME=$(git describe --tags $PREV_TAG)
          echo "Comparing changes between $PREV_TAG_NAME and $CURRENT_TAG"

          # Prüfe, ob CHANGELOG.md seit dem letzten Tag (PREV_TAG_NAME) geändert wurde
          if git diff --name-only $PREV_TAG_NAME..$CURRENT_TAG | grep -q CHANGELOG.md; then
            echo "::notice::CHANGELOG.md wurde aktualisiert. Führe Release fort."
            echo "changelog_updated=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::CHANGELOG.md wurde NICHT aktualisiert. Überspringe Release-Upload."
            echo "changelog_updated=false" >> $GITHUB_OUTPUT
          fi

      # 2. Kompilieren (Generischer Loop)
      # Findet automatisch 'typst-demo-stefan-1.typ', ignoriert '_lib.typ'
      - name: Compile Document
        run: |
          set -e
          shopt -s nullglob # Verhindert Fehler, falls keine Datei matcht

          for file in *.typ; do
            # Ignoriere Dateien, die mit '_' beginnen (z.B. _lib.typ)
            if [[ "$file" == _* ]]; then
              echo "Skipping partial file: $file"
              continue
            fi
            
            echo "Compiling $file ..."
            # Erzeugt automatisch ein PDF mit gleichem Namen (z.B. typst-demo-stefan-1.pdf)
            typst compile --font-path ./fonts "$file"
          done

      # 3. Source Code zippen
      # Wir exkludieren .git Ordner und ALLE generierten PDFs, damit die nicht doppelt im Zip landen
      - name: Archive Source Code
        run: |
          zip -r typst-project-files.zip . -x "*.git*" "*.github*" "*.pdf"

      # SCHRITT 3.5: Extrahiere nur den neuesten Eintrag aus der CHANGELOG.md
      - name: Extract Latest Changelog Entry
        if: steps.check_changelog.outputs.changelog_updated == 'true'
        run: |
          # 1. Den Inhalts-Block extrahieren (wie gehabt)
          awk '/^## / { if (n == 1) exit; n = 1 } n' CHANGELOG.md > latest_notes.md
          
          # 2. Eine Leerzeile für die Sauberkeit einfügen
          echo -e "\n" >> latest_notes.md
          
          # 3. Den spezifischen Referenz-Link für das aktuelle Tag am Ende der Datei suchen 
          # und an latest_notes.md anhängen.
          # ${{ github.ref_name }} ist z.B. "v0.3.0"
          grep "^\[${{ github.ref_name }}\]:" CHANGELOG.md >> latest_notes.md || true
          
          if [ ! -s latest_notes.md ]; then
            echo "::error::Extraktion fehlgeschlagen!"
            exit 1
          fi

      # 4. Release erstellen
      # Lädt das generierte PDF und das Source-Zip hoch
      - name: Create Release
        if: steps.check_changelog.outputs.changelog_updated == 'true'
        uses: softprops/action-gh-release@v2
        with:
          prerelease: false
          body_path: latest_notes.md
          files: |
              *.pdf
              typst-project-files.zip
