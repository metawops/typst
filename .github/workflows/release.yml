name: Publish Release
run-name: "Release ${{ github.ref_name }}"

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Typst
        uses: typst-community/setup-typst@v4
        with:
          typst-version: latest

      # 1. Kompilieren (Generischer Loop)
      # Findet automatisch 'typst-demo-stefan-1.typ', ignoriert '_lib.typ'
      - name: Compile Document
        run: |
          set -e
          shopt -s nullglob # Verhindert Fehler, falls keine Datei matcht
          
          for file in *.typ; do
            # Ignoriere Dateien, die mit '_' beginnen (z.B. _lib.typ)
            if [[ "$file" == _* ]]; then
              echo "Skipping partial file: $file"
              continue
            fi
            
            echo "Compiling $file..."
            # Erzeugt automatisch ein PDF mit gleichem Namen (z.B. typst-demo-stefan-1.pdf)
            typst compile --font-path ./fonts "$file"
          done

      # 2. Source Code zippen
      # Wir exkludieren .git Ordner und ALLE generierten PDFs, damit die nicht doppelt im Zip landen
      - name: Archive Source Code
        run: |
          zip -r typst-project-files.zip . -x "*.git*" "*.github*" "*.pdf"

      # 3. Release erstellen
      # LÃ¤dt das generierte PDF und das Source-Zip hoch
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: false 
          generate_release_notes: true
          files: |
            *.pdf
            source-code.zip